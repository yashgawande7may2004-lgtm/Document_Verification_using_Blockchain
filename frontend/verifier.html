<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Verifier Dashboard</title>
  
  <script>
    (function checkAccess() {
      // Optional: Verifiers usually don't need login.
    })();
    
    function logout() { localStorage.clear(); window.location.href = "index.html"; }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
  <script src="config.js"></script>

  <style>
    /* SHARED THEME */
    body { font-family: "Times New Roman", Times, serif; background-color: #f4f1ea; color: #333; margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
    
    h2 { text-transform: uppercase; letter-spacing: 2px; border-bottom: 3px double #333; padding-bottom: 15px; margin-top: 50px; margin-bottom: 40px; }
    
    /* Main Card */
    .box { background: #fff; padding: 30px; width: 450px; border: 1px solid #c0c0c0; box-shadow: 5px 10px 15px rgba(0,0,0,0.1); text-align: center; margin-bottom: 30px;}
    
    /* Inputs & Buttons */
    button { background-color: #2c3e50; color: white; border: 1px solid #1a252f; padding: 10px 25px; cursor: pointer; margin-top: 15px; font-size: 1rem; }
    button:hover { background-color: #1a252f; }
    
    input[type="file"] { margin-bottom: 15px; padding: 10px; background: #fafafa; border: 1px solid #ccc; width: 90%; }
    input[type="text"] { padding: 10px; width: 90%; border: 1px solid #ccc; font-family: monospace; }
    
    /* Results Area */
    #verifyResult { 
      margin-top: 20px; 
      padding: 15px; 
      background: #f9f9f9; 
      text-align: left; 
      word-wrap: break-word;
      min-height: 50px;
    }

    /* Dividers */
    .divider { border-top: 1px dashed #ccc; margin: 25px 0; position: relative; }
    .divider span { background: #fff; padding: 0 10px; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); color: #777; font-size: 0.8rem; }
    
    .menu-btn { position: absolute; top: 20px; right: 20px; font-size: 1rem; background: #e74c3c; border: none; padding: 5px 15px; }

    /* --- RICH CERTIFICATE CARD --- */
    .cert-card {
        background: white;
        border: 2px solid #27ae60;
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
        text-align: left;
        box-shadow: 0 5px 15px rgba(39, 174, 96, 0.2);
        display: none; /* Hidden by default */
        position: relative;
        overflow: hidden;
    }

    /* Watermark Effect */
    .cert-card::before {
        content: "‚úî VERIFIED";
        position: absolute;
        top: 20px;
        right: -20px;
        font-size: 80px;
        color: rgba(39, 174, 96, 0.1);
        transform: rotate(-15deg);
        font-weight: bold;
        pointer-events: none;
    }

    .cert-row {
        display: flex;
        justify-content: space-between;
        border-bottom: 1px solid #eee;
        padding: 8px 0;
        font-size: 0.9rem;
    }
    .cert-label { font-weight: bold; color: #555; }
    .cert-value { font-family: monospace; color: #333; }
    
    .view-btn {
        display: block;
        width: 100%;
        text-align: center;
        background: #27ae60;
        color: white;
        padding: 10px;
        text-decoration: none;
        border-radius: 5px;
        margin-top: 15px;
        font-weight: bold;
    }
    .view-btn:hover { background: #219150; }
  </style>
</head>
<body>

  <button class="menu-btn" onclick="logout()">Logout</button>

  <h2>üîç Document Verifier</h2>
  
  <div class="box">
    
    <h3>Option 1: Upload File</h3>
    <p style="font-size: 0.9rem; color: #666;">Select a file to check if it exists on the blockchain.</p>
    <input type="file" id="verifyFile" />
    <br>
    <button onclick="verifyByFile()">Verify File</button>

    <div class="divider"><span>OR</span></div>

    <h3>Option 2: Paste Hash</h3>
    <p style="font-size: 0.9rem; color: #666;">Enter the SHA-256 hash manually.</p>
    <input type="text" id="manualHash" placeholder="0x..." />
    <br>
    <button onclick="verifyByInput()">Verify Hash String</button>
    
    <div id="verifyResult" style="margin-top: 20px; min-height: 20px;">Waiting for input...</div>

    <div id="certCard" class="cert-card">
        <h3 style="margin: 0 0 15px 0; color: #27ae60;">‚úÖ Document Verified</h3>
        
        <div class="cert-row">
            <span class="cert-label">üìÖ Registered On:</span>
            <span class="cert-value" id="certDate">Loading...</span>
        </div>
        
        <div class="cert-row">
            <span class="cert-label">üèõÔ∏è Issued By:</span>
            <span class="cert-value" id="certIssuer">Loading...</span>
        </div>
        
        <div class="cert-row">
            <span class="cert-label">üß± Block Number:</span>
            <span class="cert-value" id="certBlock">Loading...</span>
        </div>

        <div class="cert-row">
            <span class="cert-label">üîê Document Hash:</span>
            <span class="cert-value" id="certHash">...</span>
        </div>

        <a id="certLink" href="#" target="_blank" class="view-btn">üìÑ View Original Document</a>
    </div>
  </div>

<script>
  // --- CONFIGURATION ---
  const API_URL = CONFIG.API_URL;
  const contractAddress = CONFIG.CONTRACT_ADDRESS;
  const contractABI = [
    { "anonymous": false, "inputs": [ { "indexed": true, "internalType": "bytes32", "name": "fileHash", "type": "bytes32" }, { "indexed": false, "internalType": "string", "name": "ipfsCid", "type": "string" }, { "indexed": false, "internalType": "address", "name": "owner", "type": "address" } ], "name": "DocumentRegistered", "type": "event" },
    { "inputs": [ { "internalType": "bytes32", "name": "_fileHash", "type": "bytes32" } ], "name": "getCid", "outputs": [ { "internalType": "string", "name": "", "type": "string" } ], "stateMutability": "view", "type": "function" }
  ];

  // --- 1. CORE VERIFICATION LOGIC ---
  async function verifyHashOnBlockchain(hash) {
    const resultDiv = document.getElementById("verifyResult");
    const certCard = document.getElementById("certCard");
    
    // Reset UI
    resultDiv.style.display = "block";
    resultDiv.innerHTML = "‚è≥ Checking Registry...";
    resultDiv.style.color = "blue";
    resultDiv.style.borderLeft = "none";
    resultDiv.style.backgroundColor = "#f9f9f9";
    certCard.style.display = "none";

    if (!window.ethereum) {
      alert("MetaMask is required.");
      return;
    }

    // Attempt to get user wallet for logging (Optional)
    let userWallet = "Anonymous";
    try {
        const provider = new ethers.BrowserProvider(window.ethereum);
        const signers = await provider.listAccounts();
        if (signers.length > 0) userWallet = signers[0].address;
    } catch (e) {}

    try {
      const provider = new ethers.BrowserProvider(window.ethereum);
      const contract = new ethers.Contract(contractAddress, contractABI, provider);

      if (!hash.startsWith("0x")) hash = "0x" + hash;

      // A. Check Existence
      const cid = await contract.getCid(hash);
      
      if (!cid || cid === "") {
          throw new Error("Document not found");
      }

      console.log("‚úÖ Found CID:", cid);
      
      // B. Fetch Metadata & Show Card
      await fetchDocumentDetails(contract, provider, hash, cid);
      
      // Hide the loading text (Success!)
      resultDiv.style.display = "none"; 
      
      // Log Success
      await logVerificationAttempt(hash, userWallet, "Success");

    } catch (error) {
      console.warn(error);
      resultDiv.innerHTML = `
        <div style="background:#fadbd8; color:#c0392b; padding:15px; border-left:5px solid #c0392b;">
            <strong>‚ùå Verification Failed</strong><br>
            This document hash was not found in the registry.
        </div>
      `;
      // Log Failure
      await logVerificationAttempt(hash, userWallet, "Failed");
    }
  }

  // --- 2. METADATA FETCHING (FIXED FOR RPC LIMITS) ---
  async function fetchDocumentDetails(contract, provider, hash, cid) {
      const certCard = document.getElementById("certCard");
      
      // Populate basic data immediately
      document.getElementById("certHash").innerText = hash.substring(0, 10) + "..." + hash.substring(60);
      document.getElementById("certLink").href = `https://gateway.pinata.cloud/ipfs/${cid}`;
      
      certCard.style.display = "block";
      document.getElementById("certDate").innerText = "Scanning recent history...";
      document.getElementById("certIssuer").innerText = "Scanning...";
      document.getElementById("certBlock").innerText = "...";

      try {
          // ‚ö†Ô∏è FIX: DO NOT SCAN FROM BLOCK 0
          // Scan only the last 50,000 blocks to find the event
          const currentBlock = await provider.getBlockNumber();
          const scanRange = 50000; 
          const startBlock = Math.max(0, currentBlock - scanRange);

          console.log(`Scanning logs from ${startBlock} to ${currentBlock}...`);

          const filter = contract.filters.DocumentRegistered(hash);
          
          // Use queryFilter with explicit range
          const events = await contract.queryFilter(filter, startBlock, currentBlock);

          if (events.length > 0) {
              const event = events[0];
              const blockNumber = event.blockNumber;
              const issuer = event.args[2]; 

              const block = await provider.getBlock(blockNumber);
              const date = new Date(block.timestamp * 1000).toLocaleString();

              document.getElementById("certDate").innerText = date;
              document.getElementById("certIssuer").innerText = issuer.substring(0, 10) + "...";
              document.getElementById("certBlock").innerText = "#" + blockNumber;
          } else {
              // If not found in recent blocks, show "Archived" status instead of failing
              document.getElementById("certDate").innerText = "Verified (Archived)";
              document.getElementById("certIssuer").innerText = "Verified Issuer";
              document.getElementById("certBlock").innerText = "Older than 50k blocks";
          }
      } catch (e) {
          console.error("Error fetching metadata:", e);
          document.getElementById("certDate").innerText = "Available on Blockchain";
          document.getElementById("certIssuer").innerText = "Available on Blockchain";
      }
  }

  // --- 3. DATABASE LOGGING ---
  async function logVerificationAttempt(hash, wallet, status) {
      try {
          await fetch(`${API_URL}/log-verification`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ hash, wallet, status })
          });
          console.log("üìù Logged:", status);
      } catch (e) {
          console.error("Logging failed", e);
      }
  }

  // --- 4. BUTTON HANDLERS ---
  async function verifyByInput() {
    const hashInput = document.getElementById("manualHash").value.trim();
    if (hashInput.length < 10) { alert("Please enter a valid hash"); return; }
    
    await verifyHashOnBlockchain(hashInput);
  }

  async function verifyByFile() {
    const fileInput = document.getElementById("verifyFile");
    const resultDiv = document.getElementById("verifyResult");

    if (!fileInput.files.length) { alert("Please select a file"); return; }

    resultDiv.style.display = "block";
    resultDiv.innerHTML = "‚è≥ Generating Hash...";
    
    const formData = new FormData();
    formData.append("document", fileInput.files[0]);
    const token = localStorage.getItem("token") || ""; 

    try {
      const res = await fetch(`${API_URL}/upload`, {
        method: "POST",
        headers: { "Authorization": `Bearer ${token}` },
        body: formData
      });

      const data = await res.json();
      const documentHash = data.hash; 
      
      await verifyHashOnBlockchain(documentHash);

    } catch (error) {
      console.error(error);
      resultDiv.innerText = "‚ö†Ô∏è Error calculating hash. Check console.";
    }
  }
</script>
</body>
</html>