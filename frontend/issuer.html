<!DOCTYPE html>
<html lang="en">
<head>
  <script>
  // --- üîí GATEKEEPER SCRIPT ---
  (function checkAccess() {
    const token = localStorage.getItem("token");
    const role = localStorage.getItem("userRole");
    // Remove comments below to enable login protection
    // if (!token) { alert("‚ö†Ô∏è Login required."); window.location.href = "index.html"; return; }
    // if (role !== "issuer") { alert("‚õî Access Denied"); window.location.href = "index.html"; return; }
  })();
  
  function logout() { localStorage.clear(); window.location.href = "index.html"; }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <meta charset="UTF-8">
  <title>Issuer Dashboard</title>
  <style>
    /* SHARED CLASSIC THEME */
    body { font-family: "Times New Roman", Times, serif; background-color: #f4f1ea; color: #333; margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
    h2 { text-transform: uppercase; letter-spacing: 2px; border-bottom: 3px double #333; padding-bottom: 15px; margin-top: 50px; margin-bottom: 40px; }
    .box { background: #fff; padding: 30px; width: 450px; border: 1px solid #c0c0c0; box-shadow: 5px 10px 15px rgba(0,0,0,0.1); text-align: center; margin-bottom: 30px;}
    button { background-color: #2c3e50; color: white; border: 1px solid #1a252f; padding: 10px 25px; cursor: pointer; margin-top: 10px; }
    button:hover { background-color: #1a252f; }
    input[type="file"] { margin-bottom: 15px; padding: 10px; background: #fafafa; border: 1px solid #ccc; width: 90%; }
    #qrSection { display: none; margin-top: 20px; border-top: 1px dashed #999; padding-top: 20px; }
    #qrcode { margin-top: 15px; display: flex; justify-content: center; }
  </style>
</head>
<body>

  <h2>üèõÔ∏è Authority Dashboard</h2>
  
  <div class="box">
    <h3>Document Submission</h3>
    <input type="file" id="uploadFile" />
    <br>
    <button onclick="uploadDocument()">Upload to IPFS & Blockchain</button>
    <p id="uploadResult" style="background:#f9f9f9; padding:10px; margin-top:10px;">Waiting for input...</p>

    <div id="qrSection">
      <h4>üéâ Verification Link Ready</h4>
      <p>Do you want to generate a QR code for this document?</p>
      <button onclick="generateQR()">Yes, Generate QR</button>
      <div id="qrcode"></div>
    </div>
  </div>

<script>
  // --- 1. CONFIGURATION ---
  const PINATA_JWT = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI5YWYyNjhjMi03ZmNkLTQzZjAtYTY2Ny1mMDI3MzZiNTQzZWUiLCJlbWFpbCI6InNhbmRpcGdhd2FuZGU5MDFAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInBpbl9wb2xpY3kiOnsicmVnaW9ucyI6W3siZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiRlJBMSJ9LHsiZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiTllDMSJ9XSwidmVyc2lvbiI6MX0sIm1mYV9lbmFibGVkIjpmYWxzZSwic3RhdHVzIjoiQUNUSVZFIn0sImF1dGhlbnRpY2F0aW9uVHlwZSI6InNjb3BlZEtleSIsInNjb3BlZEtleUtleSI6Ijk4MjBlNzQ1YmY2OGJmMTRkNTlkIiwic2NvcGVkS2V5U2VjcmV0IjoiMmEwN2ZjZjIxMTg2NWQ4Mzc0ODUzOTBjZGUxYzlkMTA1NjdmMGE5YjMyZWQ1ODQ3MzZkYzA0NTQwMTQxMTkxMCIsImV4cCI6MTc5OTM4NTg5MH0.7pfKyup41zCLFKMrijR_s4wsHXXYJToMHfEpEpNg5yI";
  const API_URL = "http://localhost:5000/api";
  const contractAddress = "0xEB024254d73D078A7719CAC39deD3B0E8D6C3Fc2"; //
  
  const contractABI = [
    { "anonymous": false, "inputs": [ { "indexed": true, "internalType": "bytes32", "name": "fileHash", "type": "bytes32" }, { "indexed": false, "internalType": "string", "name": "ipfsCid", "type": "string" }, { "indexed": false, "internalType": "address", "name": "owner", "type": "address" } ], "name": "DocumentRegistered", "type": "event" },
    { "inputs": [ { "internalType": "bytes32", "name": "_fileHash", "type": "bytes32" }, { "internalType": "string", "name": "_ipfsCid", "type": "string" } ], "name": "registerDocument", "outputs": [], "stateMutability": "nonpayable", "type": "function" }
  ];

  // --- 2. INTERNAL BLOCKCHAIN FUNCTION ---
  // We define this directly here to avoid "ReferenceError"
  async function registerDocumentOnBlockchain(hash, cid) {
    console.log("Starting blockchain registration...");
    
    if (!window.ethereum) {
        throw new Error("MetaMask is not installed!");
    }

    // Connect Wallet
    await window.ethereum.request({ method: "eth_requestAccounts" });
    const provider = new ethers.BrowserProvider(window.ethereum);
    const signer = await provider.getSigner();
    
    // Connect Contract
    const contract = new ethers.Contract(contractAddress, contractABI, signer);

    // Format Hash
    if (!hash.startsWith("0x")) hash = "0x" + hash;

    // Send Transaction
    const tx = await contract.registerDocument(hash, cid);
    console.log("Tx Sent:", tx.hash);
    
    // Wait for confirmation
    await tx.wait();
    console.log("Tx Confirmed");
  }

  // --- 3. UPLOAD LOGIC ---
  async function uploadDocument() {
    const fileInput = document.getElementById("uploadFile");
    const resultText = document.getElementById("uploadResult");
    const file = fileInput.files[0];

    if (!file) { alert("Please select a file"); return; }
    
    resultText.innerText = "‚è≥ Step 1: Hashing File (Server)...";
    const formData = new FormData();
    formData.append("document", file);
    const token = localStorage.getItem("token");

    try {
      // A. Get Hash from Backend
      const res = await fetch(`${API_URL}/upload`, {
        method: "POST",
        headers: { "Authorization": `Bearer ${token}` },
        body: formData
      });

      if (res.status === 401) { alert("Session expired."); logout(); return; }
      const data = await res.json();
      if (!data.hash) throw new Error("Server failed to return hash");
      
      const docHash = data.hash;
      console.log("Hash received:", docHash);

      // B. Upload to Pinata (IPFS)
      resultText.innerText = "‚è≥ Step 2: Uploading to IPFS...";
      const pinataData = new FormData();
      pinataData.append('file', file);
      
      const pinRes = await fetch("https://api.pinata.cloud/pinning/pinFileToIPFS", {
          method: "POST",
          headers: { Authorization: `Bearer ${PINATA_JWT}` },
          body: pinataData
      });
      const pinJson = await pinRes.json();
      const ipfsCid = pinJson.IpfsHash;
      console.log("IPFS CID:", ipfsCid);

      // C. Register on Blockchain
      resultText.innerText = `‚è≥ Step 3: Blockchain Transaction... (Check MetaMask)`;
      
      // CALL INTERNAL FUNCTION
      await registerDocumentOnBlockchain(docHash, ipfsCid);
      
      resultText.innerText = `‚úÖ Success! \nHash: ${docHash} \nCID: ${ipfsCid}`;
      window.currentDocHash = docHash; // Save for QR
      document.getElementById("qrSection").style.display = "block";

    } catch (err) {
      console.error(err);
      resultText.innerText = "‚ùå Error: " + (err.reason || err.message);
    }
  }

  function generateQR() {
    if (!window.currentDocHash) return;
    const verificationLink = window.location.href.replace('issuer.html', 'scan.html') + `?hash=${window.currentDocHash}`;
    const qrContainer = document.getElementById("qrcode");
    qrContainer.innerHTML = ""; 
    new QRCode(qrContainer, { text: verificationLink, width: 128, height: 128 });
  }
</script>
</body>
</html>