<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Login | Document Registry</title>
  <style>
    /* Reuse body styles for consistency */
    body {
      font-family: "Times New Roman", Times, serif;
      background-color: #f4f1ea;
      color: #333;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }

    .auth-box {
      background: #fff;
      padding: 40px;
      width: 350px;
      border: 1px solid #c0c0c0;
      box-shadow: 
        0 0 0 4px #f4f1ea,
        0 0 0 5px #8b8b8b,
        10px 10px 20px rgba(0,0,0,0.15);
      text-align: center;
    }

    h2 {
      text-transform: uppercase;
      letter-spacing: 2px;
      border-bottom: 2px solid #333;
      padding-bottom: 10px;
      margin-bottom: 30px;
    }

    .input-group {
      margin-bottom: 20px;
      text-align: left;
    }

    label {
      font-weight: bold;
      display: block;
      margin-bottom: 5px;
      font-size: 0.9rem;
    }

    input {
      width: 100%;
      padding: 10px;
      font-family: "Times New Roman", serif;
      border: 1px solid #ccc;
      background: #fafafa;
      box-sizing: border-box; 
    }

    button {
      background-color: #2c3e50;
      color: white;
      border: none;
      padding: 12px;
      width: 100%;
      font-family: "Times New Roman", serif;
      text-transform: uppercase;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 10px;
    }

    button:hover {
      background-color: #1a252f;
    }

    .toggle-link {
      margin-top: 15px;
      font-size: 0.9rem;
      color: #555;
      cursor: pointer;
      text-decoration: underline;
    }
  </style>
</head>
<body>

  <div class="auth-box">
    <h2 id="pageTitle">Login</h2>
    
    <div class="input-group">
      <label>Email / ID</label>
      <input type="text" id="email" placeholder="Enter ID">
    </div>

    <div class="input-group">
      <label>Password</label>
      <input type="password" id="password" placeholder="Enter Password">
    </div>

    <button onclick="handleAuth()" id="actionBtn">Login</button>

    <div class="toggle-link" onclick="toggleMode()">
      <span id="toggleText">New here? Create an Account</span>
    </div>
    
    <div style="margin-top: 20px; font-size: 0.8rem; color: #888;">
      <a href="index.html" style="color:#888;">&larr; Back to Home</a>
    </div>
  </div>

<script>

  const API_URL = "http://localhost:5000/api/auth"; 

  // 1. Determine Role from URL (e.g., auth.html?role=issuer)
  const urlParams = new URLSearchParams(window.location.search);
  const currentPageRole = urlParams.get('role') || 'verifier'; // "Expected" Role

  let isLoginMode = true;

  // Update Page Title
  document.getElementById('pageTitle').innerText = `${capitalize(currentPageRole)} Login`;

  function capitalize(s) { return s && s[0].toUpperCase() + s.slice(1); }

  function toggleMode() {
    isLoginMode = !isLoginMode;
    const title = document.getElementById('pageTitle');
    const btn = document.getElementById('actionBtn');
    const toggle = document.getElementById('toggleText');

    if (isLoginMode) {
      title.innerText = `${capitalize(currentPageRole)} Login`;
      btn.innerText = "Login";
      toggle.innerText = "New here? Create an Account";
    } else {
      title.innerText = `Register as ${capitalize(currentPageRole)}`;
      btn.innerText = "Register";
      toggle.innerText = "Already have an account? Login";
    }
  }

  async function handleAuth() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;

    if(!email || !password) {
      alert("Please enter credentials");
      return;
    }

    const endpoint = isLoginMode ? "/login" : "/register";
    
    // When registering, we force the role of the current page
    const payload = isLoginMode 
      ? { email, password } 
      : { email, password, role: currentPageRole }; 

    try {
      const res = await fetch(`${API_URL}${endpoint}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await res.json();

      if (res.ok) {
        if (isLoginMode) {
          
          // --- üõë BUG FIX START: STRICT ROLE CHECK üõë ---
          
          // Check if the user's actual database role matches the page they are on
          if (data.role !== currentPageRole) {
            alert(`‚ö†Ô∏è Access Denied!\n\nYou are registered as an ${data.role.toUpperCase()}, but this is the ${currentPageRole.toUpperCase()} login page.\n\nPlease go back and select the correct portal.`);
            return; // Stop the function here
          }
          
          // --- üõë BUG FIX END üõë ---

          // If roles match, proceed as normal
          localStorage.setItem("token", data.token);
          localStorage.setItem("userRole", data.role);
          
          alert("Login Successful!");
          
          if (data.role === 'issuer') {
             window.location.href = 'issuer.html';
          } else {
             window.location.href = 'verifier.html';
          }

        } else {
          alert("Registration Successful! Please Login.");
          toggleMode(); 
        }
      } else {
        alert(data.message || "Authentication failed");
      }
    } catch (err) {
      console.error(err);
      alert("Server error. Is the backend running?");
    }
  }
</script>
</body>
</html>